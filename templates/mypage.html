<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Webpage Title -->
    <title>My Page | CampuSpot</title>

    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <!-- Bulma CSS -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css"
    />
    <!-- Font Awesome CSS -->
    <link
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        rel="stylesheet"
    />
    <!-- GoogleFont -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@500&family=Nanum+Pen+Script&display=swap"
        rel="stylesheet"
    />

    <!-- JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <!-- CSS File -->
    <style>
html {
background-color: RGBA(194, 228, 120, 0.5);
font-size:16px;

}

        body {
            background-image: url('https://images.unsplash.com/photo-1532649538693-f3a2ec1bf8bd?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80');
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            height: 150vh;
            overflow: scroll;
            -ms-overflow-style: none;
        }
        ::-webkit-scrollbar {
            display: none;
        }

        .title{
        margin-top:29px;
        }

        .title-box{

        position: fixed;
        top: 0;
        left: 0;
        right: 0;

        height: 100px;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        background-color: RGBA(100, 100, 100, 0.5);
        z-index:4;
        }
        .border-nav{
            position:fixed;
            top:100px;
            width:100%;
            height: 10px;
            background-color:black;
            z-index:4;
        }

        h1 {
          display: flex;
          vertical-align: middle;
          color: white;
          margin: 0.5rem;
          padding: 0;
        }


        .nav_bar {
            position: fixed;
           top: 0;
            right: 0;
            max-width: 800px;
            min-width: 500px;
            margin-top:15px;
            text-align: center;
            display: flex;
            color: white;

        }

        .nav_btn {
            padding: 15px;
            font-size:16px;
            margin: 10px;
            border-radius: 10px;
            border: none;
            background-color: RGBA(255, 255, 255, 0.7);
            color: black;
        }
        .nav_btn2 {
            padding: 15px;
            font-size:16px;
            margin: 10px;
            border-radius: 10px;
            color: white;
            border: none;
            background-color: RGBA(100, 100, 100, 0.5);
        }
        .nav_btn3 {
            padding: 15px;
            font-size:16px;
            margin: 10px;
            border-radius: 10px;
            border: none;
            color: white;
            background-color: black;
        }


.banner {
    width: 100%;
    height: 200px;

    background-image: url(images/mypage.png);

    background-position: center;
    background-size: contain;
    background-repeat: no-repeat;

    cursor: pointer;
}

.box {
    width: 80%;
    max-width: 800px;
    margin: 300px auto;
    padding: 30px;
    z-index:3;
}

.level.is-submenu {
    margin-bottom: 50px;
    z-index:3;
}

.button.is-dark {
    margin-top: 50px;
    margin-bottom: 20px;
}
    </style>


    <script>
      function regenerateMyInfoForm() {
        $('#current-tab').text('');
        $('#current-tab').append(`<strong>내 정보</strong>`);
        $('#details').empty();
        $('#details').append(`
          <div class="field">
            <label class="label">별명</label>
            <div class="control has-icons-left has-icons-right">
              <input
                  id="input-username"
                  class="input"
                  type="text"
                  placeholder="한글, 영문 2~8자"
              />
              <span class="icon is-small is-left">
              <i class="fa fa-user"></i>
            </span>
            </div>
          </div>
        <!-- 이메일 -->
        <fieldset disabled>
          <div class="field">
            <label class="label">Email</label>
            <div class="control has-icons-left">
              <input
                  id="input-email"
                  class="input"
                  type="email"
                  placeholder="이메일"
                  value="example@gmail.com"
              />
              <span class="icon is-small is-left">
                <i class="fa fa-envelope"></i>
              </span>
            </div>
            <!-- <p class="help is-danger">This email is invalid</p> -->
          </div>
        </fieldset>
        <!-- 대학 정보 받아서 표시 -->
        <fieldset disabled>
          <div class="field">
            <label class="label">소속 대학</label>
            <div class="control has-icons-left">
              <input
                  id="input-campus"
                  class="input"
                  type="text"
                  placeholder="없음"
              />
              <span class="icon is-small is-left">
                <i class="fa fa-university"></i>
              </span>
            </div>
          </div>
        </fieldset>
        <!-- 생년월일 받아서 표시 -->
        <fieldset disabled>
          <div class="field">
            <label class="label">생년월일</label>
            <div class="control has-icons-left">
              <input
                  id="input-birth"
                  class="input"
                  type="text"
                  placeholder="0000-00-00"
              />
              <span class="icon is-small is-left">
                <i class="fa fa-birthday-cake"></i>
              </span>
            </div>
          </div>
        </fieldset>
        <!-- 수정 버튼 -->
        <button class="button is-dark" onclick="editUsername()">
          <span class="icon"><i class="fa fa-pencil-square-o"></i></span>
          <span>회원 정보 수정</span>
        </button>`);
      }

      function regenerateMyPostsForm(userInfo, myPosts, age, currentTime) {
        $('#details').append(`
        <div class="card">
          <div class="card-image">
            <figure class="image is-4by3">
              <img src="${myPosts['photo']}" alt="Placeholder image">
            </figure>
          </div>
          <div class="card-content">
            <div class="media">

              <div class="media-content">
                <p id="input-title" class="title is-4">${myPosts['title']}</p>
                <p id="input-age" class="subtitle is-6">${userInfo['username']} - ${age}세</p>
              </div>
            </div>
            <div id="input-body"  class="content">
              ${myPosts['body']}<br>
              <a id="input-campus">@${userInfo['campus']}</a><br>

        <br>
        <time datetime="2016-1-1">${currentTime}</time>
        </div>
        </div>
        </div>
        `,
        );
      }

      // 진자로 받아온 유저데이타
      const userInfo = {{ user_info|tojson }};

      $(function () {
        switch ($('#current-tab').text()) {
          case '내 정보':
            showUserInfo();
            break;
          case '내가 쓴 글':
            showMyPosts();
            break;
          default:
            alert('에러!');
        }
      });

      function showUserInfo() {

        regenerateMyInfoForm();

        $('#input-username').val(userInfo['username']);
        $('#input-email').val(userInfo['email']);
        let birth = userInfo['birth'];
        //birth = [birth.slice(0, 4), '-', birth.slice(4, 6), '-', birth.slice(6)].join('');
        //birth = birth.split('-').join('-');
        $('#input-birth').val(birth);
        $('#input-campus').val(userInfo['campus']);
      }

      function showMyPosts() {
        $.ajax({
          type: 'GET',
          url: '/api/myposts',
          data: {},
          success: function (response) {
            // post json = response['my_posts'][0]
            const today = new Date();
            const currentTime = today.toLocaleString();

            const age = today.getFullYear() - parseInt(userInfo['birth'].slice(0, 4));
            const myPosts = response['my_posts'];
            console.log(myPosts);
            $('#current-tab').text('');
            $('#current-tab').append(
              `<strong>내가 쓴 글</strong>`);
            $('#details').empty();

            myPosts.forEach(post => {
              regenerateMyPostsForm(userInfo, post, age, currentTime);
            });
          },
        });
      }

      function is_username(asValue) {
        //- 2자 이상 16자 이하, 영어 또는 숫자 또는 한글로 구성
        //* 특이사항 : 한글 초성 및 모음은 허가하지 않는다.
        const regExp = /^(?=.*[a-z0-9가-힣])[a-z0-9가-힣]{2,10}$/;
        return regExp.test(asValue);
      }

      function editUsername() {
        // 내 정보 수정 기능
        const newUsername = $('#input-username').val();
        if (newUsername === userInfo['username']) {
          alert('바뀐 것이 없습니다!');
          return;
        } else if (!is_username(newUsername)) {
          alert('한글, 영어, 숫자만 사용 가능하며, 2~16자 이내여야 합니다.');
          return;
        }

        $.ajax({
          type: 'POST',
          url: '/api/editUsername',
          data: {
            email_give: userInfo['email'],
            username_give: newUsername,
          },
          success: function (response) {
            if (response['result'] === 'success') {
              alert('별명이 성공적으로 변경되었습니다!');
            }
          },
        });
      }

      function deleteAccount() {
        $.ajax({
          type: 'GET',
          url: '/api/delete',
          data: {},
          success: function (response) {
            console.log(response);
          },
        });
        logout();
      }

      function logout() {
        $.removeCookie('campuspot_token', {path: '/'});
        alert('로그아웃 되었습니다!');
        window.location.href = '/';
      }

      function deletePost(obj) {
        const index = parseInt($(obj).next().text());
        console.log(index);

        $.ajax({
          type: 'POST',
          url: '/api/deletePost',
          data: {
            email_give: userInfo['email'],
            index_give: index,
          },
          success: function (response) {
            alert(response['msg']);
            showMyPosts();
          },
        });
      }

    </script>
  </head>
  <body>
  <header>
    <div class="title-box">
        <h1 class="title"><a href="/"><img src="/static/campuspot_logo.png"></a></h1>

            <nav class="nav_bar">
            <button class="nav_btn" onclick="location.href='/'"style='cursor:pointer;'>전체보기</button>
            <button class="nav_btn2" onclick="goCampus(this.innerHTML)"style='cursor:pointer;'>숭실대학교</button>
            <button class="nav_btn2" onclick="goCampus(this.innerHTML)"style='cursor:pointer;'>중앙대학교</button>
            <button class="nav_btn2" onclick="goCampus(this.innerHTML)"style='cursor:pointer;'>총신대학교</button>
            <button class="nav_btn3" onclick="location.href='/'" style='cursor:pointer;'>메인페이지</button>
        </nav>
    </div>
    <div class="border-nav"></div>
</header>
    {#최상단 배너: 메인페이지 링크#}
    {#회원 정보 폼#}
    <form class="box">
      <!-- 상단 메뉴바 -->
      <!-- Main container -->
      <nav class="level is-submenu">
        <!-- Left side -->
        <div class="level-left">
          <div class="level-item">
            <p id="current-tab" class="subtitle is-3"><strong>내 정보</strong></p>
          </div>
          <div class="level-item"></div>
        </div>
        <!-- 오른쪽 -->
<!--        <nav class="navbar is-transparent">-->
<!--          <div class="navbar-brand"></div>-->

<!--          <div id="navbarExampleTransparentExample" class="navbar-menu">-->
<!--            <div class="navbar-start">-->
<!--              <a class="navbar-item" onclick="showUserInfo()">-->
<!--                내 정보-->
<!--              </a>-->
<!--              <span class="navbar-item">/</span>-->
<!--              <a class="navbar-item" onclick="showMyPosts()">-->
<!--                내가 쓴 글-->
<!--              </a>-->
<!--              <span class="navbar-item">/</span>-->
<!--            </div>-->

<!--            <div class="navbar-end">-->
<!--              <div class="navbar-item">-->
<!--                <div class="field is-grouped">-->
<!--                  <p class="control">-->
<!--                    <a class="button is-primary" onclick="logout()">-->
<!--                    <span class="icon">-->
<!--                      <i class="fa fa-sign-out"></i>-->
<!--                    </span>-->
<!--                      <span>로그아웃</span>-->
<!--                    </a>-->
<!--                  </p>-->
<!--                  <p class="control">-->
<!--                    <a class="button is-danger" onclick="deleteAccount()">-->
<!--                    <span class="icon">-->
<!--                      <i class="fa fa-ban"></i>-->
<!--                    </span>-->
<!--                      <span>회원 탈퇴</span>-->
<!--                    </a>-->
<!--                  </p>-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->
<!--          </div>-->
<!--        </nav>-->
        {#        <nav class="breadcrumb is-right" aria-label="breadcrumbs">#}
        {#          <ul>#}
        {#            <li class="is-active"><a onclick="showUserInfo()">내 정보</a></li>#}
        {#            <li><a onclick="showMyPosts()">내가 쓴 글</a></li>#}
        {#            <li id="logout" class="level-item">#}
        {#              <a class="button" onclick="logout()">로그아웃</a>#}
        {#            </li>#}
        {#            <li id="delete-account" class="level-item">#}
        {#              <a class="button is-danger" onclick="deleteAccount()">회원 탈퇴</a>#}
        {#            </li>#}
        {#          </ul>#}
        {#        </nav>#}
        <!-- Right side -->
        <div class="level-right">
          <p id="my-info" class="level-item">
            <a class="button is-primary" onclick="showUserInfo()">내 정보</a>
          </p>
          <p id="my-posts" class="level-item">
            <a class="button is-link" onclick="showMyPosts()">내가 쓴 글</a>
          </p>
          <p id="logout" class="level-item">
            <a class="button" onclick="logout()">로그아웃</a>
          </p>
          <p id="delete-account" class="level-item">
            <a class="button is-danger" onclick="deleteAccount()">회원 탈퇴</a>
          </p>
        </div>
      </nav>
      <!-- 여기서부터 본문 -->
      <div id="details" class="block">

      </div>
    </form>
  </body>
</html>